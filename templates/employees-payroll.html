{% extends 'includes/layout.html' %}
{% load static %}
{% block content %} 
	<div class="wrapper">
		{% include 'includes/nav.html' %}

		<div class="main">
			{% include 'includes/nav-user.html' %}

			<main class="content">
				<div class="container-fluid p-0">

					<h1 class="h3 mb-3"><strong>Employees Payroll Info</strong></h1>

					<div class="row">
						<div class="card">
							<div class="card-body"> 
								<div class="row">
									<div class="col-12 mb-3">
										<label class="form-label">Job Role</label>
										<select class="form-select form-select-lg" id="role">
											<option value="0" selected>All Roles</option>
											{% for role in roles %}
											<option value="{{role.id}}">{{role.name}}</option> 
											{% endfor %}
										</select>
									</div> 
								</div>  
								<div class="text-center mt-3">
									<button class="btn btn-lg btn-primary" onclick="getEmployees()">Generate</button>
								</div> 
							</div>
						</div>
 					</div> 

					<div class="row" id="table">
						<div class="col-12 col-lg-12 col-xxl-12 d-flex">
							<div class="card flex-fill p-3"> 
								<div class="table-responsive">
								<table class="table table-hover my-0" id="tableData">
									<thead>
										<tr>
											<th>Id</th> 
											<th>Name</th> 
											<th>Job Role</th>
											<th>Joined Date</th>
											<th>EPF</th>
											<th>Basic Salary</th>
											<th>Allowance</th>  
											<th>Name</th>
											<th>Branch</th>
											<th>Account</th>
										</tr> 
									</thead>
									<tbody id="tableBody"> 
									</tbody>
								</table>
								</div>
							</div>
						</div> 
						<div class="text-end action-buttons">
							<button class="btn bg-white btn-outline-success btn-light mx-1px text-95" onclick="exportExcel()"><i class="mr-1 fa fa-file-excel-o text-primary-m1 text-120 w-2" style="color: #86bd68"></i> Export</button>
							<button class="btn bg-white btn-outline-danger btn-light mx-1px text-95" onclick="exportPDF()"><i class="mr-1 fa fa-file-pdf-o text-danger-m1 text-120 w-2" style="color: #dd4949"></i> Export</button>
						</div>
					</div>

				</div>
			</main>

			{% include 'includes/footer.html' %}
		</div>
	</div>  
	<script>
		$(document).ready(function(){ 
			$("#collapseEmployees").collapse()
			$("#table").hide();
		})

		function getEmployees(){
			$("#table").hide(); 
			$('#tableData').DataTable().destroy();
			role = $("#role").val()
			$.ajax({
				url: "api/v1/employees-payroll",
				type: "GET", 
				data:{
					role:role
				},
				headers: {
					"X-CSRFToken": '{{csrf_token}}'
				}, 
				mode: "same-origin",
				success: function (response) {
					rows = '';
					
					response.data.forEach(addRow);
					function addRow(item) {  
						rows += "<tr>";
							rows += "<td>" + item.id + "</td>"; 
							rows += "<td>" + item.name + "</td>";
							rows += "<td>" + item.role__name + "</td>";
							rows += "<td>" + item.employeepayrollinfo__joined_date + "</td>"; 
							rows += "<td>" + item.employeepayrollinfo__epf_number + "</td>";
							rows += "<td>" + item.employeepayrollinfo__basic_salary + "</td>"; 
							rows += "<td>" + item.employeepayrollinfo__allowance + "</td>"; 
							rows += "<td>" + item.employeebankaccount__bank + "</td>";
							rows += "<td>" + item.employeebankaccount__branch + "</td>"; 
							rows += "<td>" + item.employeebankaccount__account_number + "</td>"; 
						rows += "</tr>";
					}
					$('#tableBody').html(rows); 
					$('#tableData').DataTable();
					$("#table").show();
				}
			});
		}
		function exportExcel(){
			$("#tableData").tableHTMLExport({type:'csv',filename:'employees_payroll.csv',ignoreColumns:'.ignore',ignoreRows: '.ignore'});
		}
		function exportPDF(){
			$("#tableData").tableHTMLExport({type:'pdf',filename:'employees_payroll.pdf',ignoreColumns:'.ignore',ignoreRows: '.ignore'});
		}
	</script>
{% endblock %}